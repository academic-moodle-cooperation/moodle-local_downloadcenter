{"version":3,"file":"modfilter.min.js","sources":["../src/modfilter.js"],"sourcesContent":["/**\n * Handles filtering of items\n *\n * @module        local_downloadcenter/modfilter\n * @author        Simeon Naydenov (moniNaydenov@gmail.com)\n * @copyright     2022 Academic Moodle Cooperation {@link http://www.academic-moodle-cooperation.org}\n * @license       http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_downloadcenter/modfilter\n */\ndefine(['jquery', 'core/str', 'core/url'], function($, Str, url) {\n\n    var ModFilter = function(modnames) {\n\n        var instance = this;\n        this.modnames = modnames;\n        this.strings = {};\n        this.formid = null;\n        this.currentlyshown = false;\n        this.modlist = null;\n\n        Str.get_strings([\n            {key: 'all', component: 'moodle'},\n            {key: 'none', component: 'moodle'},\n            {key: 'select', component: 'moodle'},\n            {key: 'showtypes', component: 'backup'},\n            {key: 'hidetypes', component: 'backup'}\n        ]).done(function(strs) {\n            // Init strings.. new moodle super cool way...\n            instance.strings['all'] = strs[0];\n            instance.strings['none'] = strs[1];\n            instance.strings['select'] = strs[2];\n            instance.strings['showtypes'] = strs[3];\n            instance.strings['hidetypes'] = strs[4];\n\n            var firstsection = $('div[role=\"main\"] > form .card.block').first();\n            instance.formid = firstsection.closest('form').prop('id');\n\n            // Add global select all/none options...\n            var html = instance.html_generator('included', instance.strings['select']);\n            html += instance.row_generator(\n                '(<a id=\"downloadcenter-bytype\" href=\"#\">' + instance.strings['showtypes'] + '</a>)',\n                ''); // I hope this looks better than on one line :)!\n            var links = $(document.createElement('div'));\n            links.addClass('grouped_settings section_level block card');\n            links.html(html);\n\n            links.insertBefore(firstsection);\n\n            // For each module type on the course, add hidden select all/none options.\n            instance.modlist = $(document.createElement('div'));\n            instance.modlist.prop('id', 'mod_select_links');\n            instance.modlist.prop('class', 'm-l-2');\n            instance.modlist.appendTo(links);\n            instance.modlist.hide();\n\n            for (var mod in instance.modnames) {\n                // Only include actual values from the list..\n                if (!instance.modnames.hasOwnProperty(mod)) {\n                    continue;\n                }\n\n                var img = '<img src=\"' + url.imageUrl('icon', 'mod_' + mod) + '\" class=\"activityicon\" />';\n                html = instance.html_generator('mod_' + mod, img + instance.modnames[mod]);\n                var modlinks = $(document.createElement('div'));\n                modlinks.addClass('grouped_settings section_level');\n                modlinks.html(html);\n                modlinks.appendTo(instance.modlist);\n                instance.initlinks(modlinks, mod);\n            }\n\n            // Attach events to links!\n            $('#downloadcenter-all-included').click(function(e) { instance.helper(e, true,  'item_'); });\n            $('#downloadcenter-none-included').click(function(e) { instance.helper(e, false, 'item_'); });\n            $('#downloadcenter-bytype').click(function(e) { e.preventDefault(); instance.toggletypes(); });\n            // Attach event to checkboxes!\n            $('input.form-check-input').click(function() { instance.checkboxhandler($(this)); instance.updateFormState(); });\n        });\n\n    };\n\n    ModFilter.prototype.checkboxhandler = function($checkbox) {\n        var prefix = 'item_topic';\n        var shortprefix = 'item_';\n        var name = $checkbox.prop('name');\n        var checked = $checkbox.prop('checked');\n        if (name.substring(0, shortprefix.length) === shortprefix) {\n            var $parent = $checkbox.parentsUntil('form', '.card');\n            if (name.substring(0, prefix.length) === prefix) {\n                $parent.find('input.form-check-input').prop('checked', checked);\n            } else {\n                if (checked) {\n                    $parent.find('input.form-check-input[name^=\"item_topic\"]').prop('checked', true);\n                }\n            }\n        }\n    };\n\n    ModFilter.prototype.updateFormState = function() {\n        // At this point, we really need to persuade the form we are part of to\n        // update all of its disabledIf rules. However, as far as I can see,\n        // given the way that lib/form/form.js is written, that is impossible.\n        if (this.formid && M.form && M.form.updateFormState) {\n            M.form.updateFormState(this.formid);\n        }\n    };\n\n    // Toggles the display of the hidden module select all/none links.\n    ModFilter.prototype.toggletypes = function() {\n        // Change text of type toggle link.\n        var link = $('#downloadcenter-bytype');\n        if (this.currentlyshown) {\n            link.text(this.strings['showtypes']);\n        } else {\n            link.text(this.strings['hidetypes']);\n        }\n        this.modlist.animate({height: 'toggle' }, 500, 'swing');\n\n        this.currentlyshown = !this.currentlyshown;\n\n    };\n\n    ModFilter.prototype.initlinks = function(links, mod) {\n        var instance = this;\n        $('#downloadcenter-all-mod_' + mod).click(function(e) { instance.helper(e, true, 'item_', mod); });\n        $('#downloadcenter-none-mod_' + mod).click(function(e) { instance.helper(e, false, 'item_', mod); });\n\n    };\n\n    ModFilter.prototype.helper = function(e, check, type, mod) {\n        e.preventDefault();\n        var prefix = '';\n        if (typeof mod !== 'undefined') {\n            prefix = 'item_' + mod + '_';\n        }\n\n        var len = type.length;\n\n        $('input[type=\"checkbox\"]').each(function(i, checkbox) {\n            checkbox = $(checkbox);\n            var name = checkbox.prop('name');\n\n            // If a prefix has been set, ignore checkboxes which don't have that prefix.\n            if (prefix && name.substring(0, prefix.length) !== prefix) {\n                return;\n            }\n            if (name.substring(0, len) === type) {\n                checkbox.prop('checked', check);\n            }\n            if (check) {\n                checkbox.closest('.card.block').find('.form-group:first-child input').prop('checked', check);\n            }\n        });\n\n        this.updateFormState();\n    };\n\n    ModFilter.prototype.html_generator = function(idtype, heading) {\n        var links = '<a id=\"downloadcenter-all-' + idtype + '\" href=\"#\">' + this.strings['all'] + '</a> / ';\n        links += '<a id=\"downloadcenter-none-' + idtype + '\" href=\"#\">' + this.strings['none'] + '</a>';\n        return this.row_generator(heading, links);\n    };\n\n    ModFilter.prototype.row_generator = function(heading, content) {\n        var ret = '<div class=\"form-group row fitem downloadcenter_selector\">';\n        ret += '<div class=\"col-md-3\"></div>';\n        ret += '<div class=\"col-md-9\">';\n        ret += '<label><span class=\"itemtitle\">' + heading + '</span></label>';\n        ret += '<span class=\"text-nowrap\">' + content + '</span>';\n        ret += '</div>';\n        ret += '</div>';\n        return ret;\n    };\n\n    return {\n        init: function(modnames) {\n            return new ModFilter(modnames);\n        }\n    };\n});"],"names":["define","$","Str","url","ModFilter","modnames","instance","this","strings","formid","currentlyshown","modlist","get_strings","key","component","done","strs","firstsection","first","closest","prop","html","html_generator","row_generator","links","document","createElement","mod","addClass","insertBefore","appendTo","hide","hasOwnProperty","img","imageUrl","modlinks","initlinks","click","e","helper","preventDefault","toggletypes","checkboxhandler","updateFormState","prototype","$checkbox","prefix","name","checked","substring","length","$parent","parentsUntil","find","M","form","link","text","animate","height","check","type","len","each","i","checkbox","idtype","heading","content","ret","init"],"mappings":"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"}