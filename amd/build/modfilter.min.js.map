{"version":3,"sources":["../src/modfilter.js"],"names":["define","$","Str","url","ModFilter","modnames","instance","strings","formid","currentlyshown","modlist","get_strings","key","component","done","strs","firstsection","first","closest","prop","html","html_generator","row_generator","links","document","createElement","addClass","insertBefore","appendTo","hide","mod","hasOwnProperty","img","imageUrl","modlinks","initlinks","click","e","helper","preventDefault","toggletypes","checkboxhandler","updateFormState","prototype","$checkbox","shortprefix","name","checked","substring","length","$parent","parentsUntil","find","M","form","link","text","animate","height","check","type","prefix","len","each","i","checkbox","idtype","heading","content","ret","init"],"mappings":"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","sourcesContent":["/*\n * @package     local_downloadcenter\n * @author      Simeon Naydenov (moniNaydenov@gmail.com)\n * @copyright   2020 AMC\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module local_downloadcenter/modfilter\n */\ndefine(['jquery', 'core/str', 'core/url'], function($, Str, url) {\n\n    /**\n     * @constructor\n     */\n    var ModFilter = function(modnames) {\n\n        var instance = this;\n        this.modnames = modnames;\n        this.strings = {};\n        this.formid = null;\n        this.currentlyshown = false;\n        this.modlist = null;\n\n        Str.get_strings([\n            {key: 'all', component: 'moodle'},\n            {key: 'none', component: 'moodle'},\n            {key: 'select', component: 'moodle'},\n            {key: 'showtypes', component: 'backup'},\n            {key: 'hidetypes', component: 'backup'}\n        ]).done(function(strs) {\n            // Init strings.. new moodle super cool way...\n            instance.strings['all'] = strs[0];\n            instance.strings['none'] = strs[1];\n            instance.strings['select'] = strs[2];\n            instance.strings['showtypes'] = strs[3];\n            instance.strings['hidetypes'] = strs[4];\n\n            var firstsection = $('div[role=\"main\"] > form .card.block').first();\n            instance.formid = firstsection.closest('form').prop('id');\n\n            // Add global select all/none options...\n            var html = instance.html_generator('included', instance.strings['select']);\n            html += instance.row_generator(\n                '(<a id=\"downloadcenter-bytype\" href=\"#\">' + instance.strings['showtypes'] + '</a>)',\n                ''); // I hope this looks better than on one line :)!\n            var links = $(document.createElement('div'));\n            links.addClass('grouped_settings section_level block card');\n            links.html(html);\n\n            links.insertBefore(firstsection);\n\n            // For each module type on the course, add hidden select all/none options.\n            instance.modlist = $(document.createElement('div'));\n            instance.modlist.prop('id', 'mod_select_links');\n            instance.modlist.prop('class', 'm-l-2');\n            instance.modlist.appendTo(links);\n            instance.modlist.hide();\n\n            for (var mod in instance.modnames) {\n                // Only include actual values from the list..\n                if (!instance.modnames.hasOwnProperty(mod)) {\n                    continue;\n                }\n\n                var img = '<img src=\"' + url.imageUrl('icon', 'mod_' + mod) + '\" class=\"activityicon\" />';\n                html = instance.html_generator('mod_' + mod, img + instance.modnames[mod]);\n                var modlinks = $(document.createElement('div'));\n                modlinks.addClass('grouped_settings section_level');\n                modlinks.html(html);\n                modlinks.appendTo(instance.modlist);\n                instance.initlinks(modlinks, mod);\n            }\n\n            // Attach events to links!\n            $('#downloadcenter-all-included').click(function(e) { instance.helper(e, true,  'item_'); });\n            $('#downloadcenter-none-included').click(function(e) { instance.helper(e, false, 'item_'); });\n            $('#downloadcenter-bytype').click(function(e) { e.preventDefault(); instance.toggletypes(); });\n            // Attach event to checkboxes!\n            $('input.form-check-input').click(function() { instance.checkboxhandler($(this)); instance.updateFormState(); });\n        });\n\n    };\n\n    ModFilter.prototype.checkboxhandler = function($checkbox) {\n        var prefix = 'item_topic';\n        var shortprefix = 'item_';\n        var name = $checkbox.prop('name');\n        var checked = $checkbox.prop('checked');\n        if (name.substring(0, shortprefix.length) === shortprefix) {\n            var $parent = $checkbox.parentsUntil('form', '.card');\n            if (name.substring(0, prefix.length) === prefix) {\n                $parent.find('input.form-check-input').prop('checked', checked);\n            } else {\n                if (checked) {\n                    $parent.find('input.form-check-input[name^=\"item_topic\"]').prop('checked', true);\n                }\n            }\n        }\n    };\n\n    ModFilter.prototype.updateFormState = function() {\n        // At this point, we really need to persuade the form we are part of to\n        // update all of its disabledIf rules. However, as far as I can see,\n        // given the way that lib/form/form.js is written, that is impossible.\n        if (this.formid && M.form && M.form.updateFormState) {\n            M.form.updateFormState(this.formid);\n        }\n    };\n\n    // Toggles the display of the hidden module select all/none links.\n    ModFilter.prototype.toggletypes = function() {\n        // Change text of type toggle link.\n        var link = $('#downloadcenter-bytype');\n        if (this.currentlyshown) {\n            link.text(this.strings['showtypes']);\n        } else {\n            link.text(this.strings['hidetypes']);\n        }\n        this.modlist.animate({height: 'toggle' }, 500, 'swing');\n\n        this.currentlyshown = !this.currentlyshown;\n\n    };\n\n    ModFilter.prototype.initlinks = function(links, mod) {\n        var instance = this;\n        $('#downloadcenter-all-mod_' + mod).click(function(e) { instance.helper(e, true, 'item_', mod); });\n        $('#downloadcenter-none-mod_' + mod).click(function(e) { instance.helper(e, false, 'item_', mod); });\n\n    };\n\n    ModFilter.prototype.helper = function(e, check, type, mod) {\n        e.preventDefault();\n        var prefix = '';\n        if (typeof mod !== 'undefined') {\n            prefix = 'item_' + mod + '_';\n        }\n\n        var len = type.length;\n\n        $('input[type=\"checkbox\"]').each(function(i, checkbox) {\n            checkbox = $(checkbox);\n            var name = checkbox.prop('name');\n\n            // If a prefix has been set, ignore checkboxes which don't have that prefix.\n            if (prefix && name.substring(0, prefix.length) !== prefix) {\n                return;\n            }\n            if (name.substring(0, len) === type) {\n                checkbox.prop('checked', check);\n            }\n            if (check) {\n                checkbox.closest('.card.block').find('.form-group:first-child input').prop('checked', check);\n            }\n        });\n\n        this.updateFormState();\n    };\n\n    ModFilter.prototype.html_generator = function(idtype, heading) {\n        var links = '<a id=\"downloadcenter-all-' + idtype + '\" href=\"#\">' + this.strings['all'] + '</a> / ';\n        links += '<a id=\"downloadcenter-none-' + idtype + '\" href=\"#\">' + this.strings['none'] + '</a>';\n        return this.row_generator(heading, links);\n    };\n\n    ModFilter.prototype.row_generator = function(heading, content) {\n        var ret = '<div class=\"form-group row fitem downloadcenter_selector\">';\n        ret += '<div class=\"col-md-3\"></div>';\n        ret += '<div class=\"col-md-9\">';\n        ret += '<label><span class=\"itemtitle\">' + heading + '</span></label>';\n        ret += '<span class=\"text-nowrap\">' + content + '</span>';\n        ret += '</div>';\n        ret += '</div>';\n        return ret;\n    };\n\n    return {\n        init: function(modnames) {\n            return new ModFilter(modnames);\n        }\n    };\n});"],"file":"modfilter.min.js"}